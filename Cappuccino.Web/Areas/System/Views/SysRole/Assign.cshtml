@model Cappuccino.Model.SysRoleModel
@{
    ViewBag.Title = "Assign";
    Layout = "~/Views/Shared/_LayoutForm.cshtml";
}

<div class="layui-form">
    @Html.HiddenFor(x => x.Id)
    <div class="mainBox">
        <div class="main-container">
            <div class="main-container">
                <div class="layui-form-item">
                    <label class="layui-form-label">角色名</label>
                    <div class="layui-input-block">
                        <input type="text" name="configValue" value="@Model.Name" class="layui-input" disabled="disabled">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">数据权限</label>
                    <div class="layui-input-block">
                        <input type="checkbox" name="expandAllCb" id="expandAllCb" lay-filter="dtreeCheck" lay-skin="primary" title="展开/折叠">
                        <input type="checkbox" name="checkAllCb" id="checkAllCb" lay-filter="dtreeCheck" lay-skin="primary" title="全选/不全选">
                        <input type="checkbox" name="linkageCheck" id="linkageCheck" lay-filter="dtreeCheck" lay-skin="primary" title="父子联动" checked>
                        <div style="overflow: auto; margin-top: 10px;">
                            <ul id="assignDataTree" class="dtree" data-id="0"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="bottom">
        <div class="button-container">
            <button type="submit" class="layui-btn layui-btn-normal layui-btn-sm" onclick="save()">
                <i class="layui-icon layui-icon-ok"></i>
                提交
            </button>
            <button type="reset" class="layui-btn layui-btn-primary layui-btn-sm" onclick="reset()">
                <i class="layui-icon layui-icon-refresh"></i>
                重置
            </button>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        layui.use(['form', 'jquery', 'common', 'dtree'], function () {
            let form = layui.form;
            let $ = layui.jquery;
            let common = layui.common;
            let dtree = layui.dtree;

            // 数据权限
            var treeConfig = {
                elem: "#assignDataTree",
                url: "/System/SysDepartment/GetDepartmentDtree/@Model.Id",
                method: "get",
                checkbar: true,  //开启复选框
                line: true,
                icon: ["0", "-1"], //显示非最后一级节点图标，隐藏最后一级节点图标
                ficon: ["1", "7"],
                checkbarType: "all", // 初始开启父子联动（关键配置）
                initLevel: 2,  //默认展开层级
            };

            // 渲染树
            var treeIns = dtree.render(treeConfig);

            window.reset = function () {
                location.reload();
            }

            window.save = function () {
                var dataParams = dtree.getCheckbarNodesParam("assignDataTree");
                common.ajax("/System/SysRole/Assign", "post", {
                    id: "@Model.Id",
                    dataPermissions: dataParams
                }, true, true).done(function (response) {
                    layer.msg(response.msg, { icon: 1, time: 1000 }, function () {
                        parent.layer.close(parent.layer.getFrameIndex(window.name));
                    });
                }).fail(function (error) {
                    console.log(error);
                });
                return false;
            };

            form.on('checkbox(dtreeCheck)', function (data) {
                if (data.elem.id === 'expandAllCb') {
                    // 展开/折叠
                    data.elem.checked ? treeIns.menubarMethod().openAllNode() : treeIns.menubarMethod().closeAllNode();
                } else if (data.elem.id === 'checkAllCb') {
                    // 全选/全不选（联动模式下会同步处理父子节点）
                    data.elem.checked ? treeIns.checkAllNode("assignDataTree") : treeIns.cancelCheckedNode("assignDataTree");
                } else if (data.elem.id === 'linkageCheck') {
                    // 父子联动切换（核心修改）
                    var oldCheckedIds = [];
                    // 1. 保存当前已勾选节点ID（避免切换后勾选状态丢失）
                    var checkedNodes = dtree.getCheckbarNodesParam("assignDataTree");
                    if (checkedNodes.length > 0) {
                        oldCheckedIds = checkedNodes.map(item => item.nodeId).join(",");
                    }

                    // 2. 修改联动配置并刷新树
                    treeConfig.checkbarType = data.elem.checked ? "all" : "self";
                    treeIns = dtree.reload("assignDataTree", treeConfig);

                    // 3. 恢复之前的勾选状态
                    if (oldCheckedIds) {
                        treeIns.chooseDataInit(oldCheckedIds);
                        // 4. 联动模式下，初始化父子节点状态（子节点同步父节点勾选）
                        if (data.elem.checked) {
                            treeIns.initAllCheck();
                        }
                    }
                }
            });
        });

    </script>
}
